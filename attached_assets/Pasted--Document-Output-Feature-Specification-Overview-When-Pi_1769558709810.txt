# Document Output Feature Specification

## Overview

When PitCrew generates long-form content, output a **.docx file** instead of a wall of text in Slack. Before generating, **ask clarifying questions** to tailor the document.

---

## User Experience Flow

### Current (Bad)
```
User: "Explain PitCrew value propositions for ACE"
Bot:  [400 words of generic content dumped in Slack]
```

### Proposed (Good)
```
User: "Explain PitCrew value propositions for ACE"

Bot:  "Happy to put together a value prop doc for ACE. Quick questions:

      1. Who's the audience â€” execs, ops managers, or IT?
      2. What's the goal â€” intro meeting, proposal, or follow-up?
      3. Any specific pain points they've mentioned?

      Or just say 'go' and I'll create a general version!"

User: "Execs, it's for a proposal"

Bot:  "ğŸ“„ ACE_Value_Proposition.docx

      Executive-focused proposal doc for ACE:
      â€¢ Strategic value summary
      â€¢ ROI framework  
      â€¢ Implementation timeline
      â€¢ Recommended next steps

      Want me to adjust anything?"
```

---

## When to Trigger Document Output

### Always Generate Document
| Contract | Why |
|----------|-----|
| VALUE_PROPOSITION | Always long, needs formatting |
| MEETING_SUMMARY | Better as shareable doc |
| COMPARISON | Tables render poorly in Slack |
| PATTERN_ANALYSIS | Charts/tables needed |
| DRAFT_EMAIL | User will copy anyway |
| DRAFT_RESPONSE | User will copy anyway |

### Generate Document if Long (>300 words)
| Contract | Condition |
|----------|-----------|
| PRODUCT_EXPLANATION | If detailed explanation |
| FAQ_ANSWER | If multiple questions |
| NEXT_STEPS | If many action items |

### Never Generate Document
| Contract | Why |
|----------|-----|
| EXTRACTIVE_FACT | Short, direct answer |
| CLARIFY | Just a question |
| REFUSE | Just a message |
| NOT_FOUND | Just a message |

---

## Pre-Generation Questions by Contract Type

### VALUE_PROPOSITION
```
"Happy to create a value prop doc. Quick questions:

1. Who's the audience â€” execs, ops managers, IT, or mixed?
2. What's the context â€” intro, proposal, renewal, or expansion?
3. Any specific outcomes they care about (throughput, visibility, cost)?

Or say 'go' for a general version!"
```

### MEETING_SUMMARY
```
"I'll put together a summary doc. What format works best?

1. Internal debrief (detailed, with action items)
2. Customer follow-up (polished, shareable)
3. Executive brief (high-level, 1 page)

Or say 'go' for a standard summary!"
```

### COMPARISON
```
"I can compare these in a doc. What angle?

1. Feature comparison (what each said about specific topics)
2. Sentiment comparison (overall tone and concerns)
3. Timeline view (how perspectives changed over time)

Or say 'go' for a general comparison!"
```

### DRAFT_EMAIL / DRAFT_RESPONSE
```
"I'll draft that for you. Quick questions:

1. What's the tone â€” formal, friendly, or direct?
2. What's the goal â€” inform, request, or persuade?
3. Any specific points to include or avoid?

Or say 'go' and I'll create a solid first draft!"
```

### PATTERN_ANALYSIS
```
"I'll analyze the patterns in a doc. What focus?

1. By topic (what themes keep coming up)
2. By customer (how different accounts compare)  
3. By time (how feedback has evolved)

Or say 'go' for an overall analysis!"
```

---

## Document Templates

### Base Template Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Leverege Logo]                    â”‚
â”‚                                     â”‚
â”‚  DOCUMENT TITLE                     â”‚
â”‚  Generated by PitCrew â€¢ [Date]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [Content sections with proper      â”‚
â”‚   H1, H2, bullets, tables]          â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Generated by PitCrew               â”‚
â”‚  For internal use                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Style Guide
| Element | Style |
|---------|-------|
| Title | 24pt, Bold, Navy |
| H1 | 16pt, Bold, Navy |
| H2 | 14pt, Bold, Dark Gray |
| Body | 11pt, Regular, Black |
| Bullets | 11pt, Indented |
| Tables | Bordered, Header row shaded |
| Footer | 9pt, Gray, Italic |

### Template Files Needed
```
server/templates/
â”œâ”€â”€ base.docx              # Base template with branding
â”œâ”€â”€ value_proposition.docx # Sections for value props
â”œâ”€â”€ meeting_summary.docx   # Sections for summaries
â”œâ”€â”€ comparison.docx        # Table-heavy layout
â””â”€â”€ email_draft.docx       # Simple, copyable format
```

---

## Implementation

### 1. Install Dependencies
```bash
npm install docx
```

### 2. Document Generator Service
```typescript
// server/services/documentGenerator.ts

import { Document, Packer, Paragraph, TextRun, HeadingLevel, Table } from 'docx';

interface DocumentRequest {
  type: 'value_proposition' | 'meeting_summary' | 'comparison' | 'email_draft';
  title: string;
  sections: DocumentSection[];
  metadata: {
    customer?: string;
    audience?: string;
    date: string;
  };
}

interface DocumentSection {
  heading: string;
  level: 1 | 2;
  content: string | string[] | TableData;
}

async function generateDocument(request: DocumentRequest): Promise<Buffer> {
  const doc = new Document({
    sections: [{
      properties: {},
      children: [
        // Title
        new Paragraph({
          text: request.title,
          heading: HeadingLevel.TITLE,
        }),
        // Metadata
        new Paragraph({
          children: [
            new TextRun({
              text: `Generated by PitCrew â€¢ ${request.metadata.date}`,
              italics: true,
              color: "888888",
            }),
          ],
        }),
        // Sections
        ...request.sections.flatMap(section => renderSection(section)),
      ],
    }],
  });

  return await Packer.toBuffer(doc);
}
```

### 3. Slack Upload Integration
```typescript
// server/slack/fileUpload.ts

async function uploadDocumentToSlack(
  channel: string,
  threadTs: string,
  fileName: string,
  fileBuffer: Buffer,
  summary: string
): Promise<void> {
  
  // Upload file
  await slackClient.files.uploadV2({
    channel_id: channel,
    thread_ts: threadTs,
    filename: fileName,
    file: fileBuffer,
    title: fileName,
  });

  // Post summary message
  await slackClient.chat.postMessage({
    channel,
    thread_ts: threadTs,
    text: summary,
  });
}
```

### 4. Handler Integration
```typescript
// In openAssistantHandler.ts

async function handleDocumentResponse(
  contract: AnswerContract,
  content: GeneratedContent,
  context: AssistantContext
): Promise<void> {
  
  const shouldGenerateDoc = DOCUMENT_CONTRACTS.includes(contract) ||
    content.text.length > 1500; // ~300 words
  
  if (shouldGenerateDoc) {
    // Generate document
    const docBuffer = await generateDocument({
      type: contractToDocType(contract),
      title: content.title,
      sections: content.sections,
      metadata: {
        customer: context.company?.name,
        date: new Date().toLocaleDateString(),
      },
    });

    // Upload to Slack
    const fileName = `${content.title.replace(/\s+/g, '_')}.docx`;
    await uploadDocumentToSlack(
      context.channel,
      context.threadTs,
      fileName,
      docBuffer,
      content.summary  // Short summary for Slack
    );
  } else {
    // Normal Slack message
    await postToSlack(context, content.text);
  }
}
```

---

## Pre-Generation Question Flow

### State Machine
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Request   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Already has context?
â”‚ Check Context   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
         â”‚ No                              â”‚ Yes
         â–¼                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚ Ask Questions   â”‚                        â”‚
â”‚ (with defaults) â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
         â”‚                                 â”‚
         â–¼                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚ User Response   â”‚                        â”‚
â”‚ or "go"         â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
         â”‚                                 â”‚
         â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Generate Document                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Skip Questions When:
- User says "quick" or "just give me"
- User already specified details: "exec summary for proposal"
- Follow-up in same thread with context already established
- Simple requests: "summarize the meeting" (no customization needed)

### Always Ask When:
- VALUE_PROPOSITION (audience matters a lot)
- COMPARISON (angle matters)
- DRAFT_EMAIL (tone matters)

---

## File Naming Convention

```
{Customer}_{DocumentType}_{Date}.docx

Examples:
- ACE_Value_Proposition_2026-01-27.docx
- Les_Schwab_Meeting_Summary_2026-01-27.docx
- Customer_Comparison_ACE_vs_Les_Schwab_2026-01-27.docx
- Follow_Up_Email_Draft_2026-01-27.docx
```

---

## Success Metrics

| Metric | Target |
|--------|--------|
| Long responses as docs | >90% |
| User edits doc before sending | Track |
| "Can you make it a doc" requests | â†’ 0 (already is) |
| Time to usable output | <30 seconds |

---

## Summary for Replit

1. **Install `docx` package**
2. **Create document generator service** with templates
3. **Add pre-generation questions** for key contracts
4. **Integrate with Slack file upload**
5. **Add "go" shortcut** to skip questions