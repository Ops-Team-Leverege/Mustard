Fix Duplicate Messages + Attendee Intent Routing (Cleanly)
Context (read carefully)

We have a Slack-based assistant with bounded MCP capabilities and deterministic routing.

Recent changes introduced two issues:

Duplicate Slack responses

Slack sends both app_mention and message.channels when a bot is @mentioned inside a thread.

The bot responds twice.

â€œWho attended the meeting?â€ returns the wrong capability

The system routes this question to a summary capability instead of returning the attendee list.

This is not a one-off fix problem â€” we need a clean intent boundary, not special-case hacks.

Design Constraints (DO NOT VIOLATE)

âŒ Do NOT add a high-priority rule for every possible question
âŒ Do NOT introduce free-form chat
âŒ Do NOT feed prior answers into the LLM
âŒ Do NOT introduce RAG or embeddings
âŒ Do NOT solve this with regex spaghetti

âœ… Keep capabilities bounded
âœ… Keep intent detection explicit but minimal
âœ… Prefer capability-level routing, not question-level rules

What to Implement
1ï¸âƒ£ Fix Duplicate Slack Messages (Deterministically)

Problem
When a user @mentions the bot inside a thread, Slack sends:

app_mention

message.channels

Both are currently being processed.

Fix (required)

In the Slack events handler:

If handling a message.channels event AND the message contains an @bot mention:

Ignore it

Let app_mention handle the response

This ensures:

One response per user message

No race conditions

No Slack-side hacks

ğŸ‘‰ This logic must live before routing, not after.

2ï¸âƒ£ Add an Attendee Capability (Not a Priority Rule)

Key insight:
â€œWho attended the meeting?â€ is not a summary variant â€” itâ€™s a data retrieval capability.

Do not treat this as a special-case override. Treat it as a first-class intent.

Add a new capability:

Capability name: getMeetingAttendees

Purpose:
Return the list of attendees for a resolved meeting:

Leverege team

Customer attendees

Input:

meetingId (preferred)

companyId (fallback)

companyName (last resort)

Output:

Simple, structured attendee list

No LLM reasoning required

3ï¸âƒ£ Minimal Intent Classification (One New Intent Class)

Add a small intent detector:

isAttendeeQuestion(messageText): boolean


Triggers on:

â€œwho attendedâ€

â€œwho was in the meetingâ€

â€œparticipantsâ€

â€œattendeesâ€

Thatâ€™s it.
No hierarchy explosion.
No per-question logic.

4ï¸âƒ£ Routing Order (Very Important)

Routing should follow this order:

Attendee questions â†’ getMeetingAttendees

Next steps / action items â†’ commitment extraction

Specific factual questions â†’ extractive Q&A

Summary requests â†’ meeting summary

This is capability precedence, not question-by-question rules.

Add a comment explaining this order and why.

5ï¸âƒ£ Thread Context Reuse (Already Implemented â€” Just Ensure It Works)

Confirm that:

meetingId and companyId injected from thread context

Input schemas accept these optional IDs (Zod must not strip them)

Attendee capability uses IDs directly if present

No new logic needed â€” just make sure the attendee capability honors seeded context.

6ï¸âƒ£ Logging (No Changes)

Log attendee questions like any other interaction

Record:

capability name

resolved meetingId

question + answer

No special casing.

Explicit Non-Goals (Do NOT Implement)

âŒ No â€œhigh-priority rule for every questionâ€
âŒ No conversation memory
âŒ No LLM deciding which capability to call
âŒ No RAG
âŒ No summary fallback for attendee questions

Expected Behavior After This Change

âœ… One response per Slack message
âœ… â€œWho attended the meeting?â€ returns attendees â€” not a summary
âœ… Thread follow-ups reuse meeting context correctly
âœ… Capability set stays small, auditable, and extensible
âœ… No explosion of intent rules